<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Tracker Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #4a90e2; --danger: #e74c3c; --success: #27ae60; --warning: #f39c12; --bg: #f4f7f6; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 600px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* 認証・表示切り替え */
        .auth-section { text-align: right; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; width: 100%; }
        #authBtn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .user-info { display: none; align-items: center; gap: 10px; justify-content: flex-end; }
        #logoutBtn { background: none; border: none; color: #999; cursor: pointer; text-decoration: underline; }

        /* メインコンテンツ */
        .timer-display { font-size: 3.5rem; font-weight: bold; text-align: center; margin: 15px 0; color: #333; font-variant-numeric: tabular-nums; }
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input, select { padding: 12px; border: 2px solid #eee; border-radius: 8px; outline: none; font-size: 1rem; box-sizing: border-box; }
        input[type="text"] { flex: 2; }
        select { flex: 1; }
        
        .controls { display: flex; gap: 10px; margin-bottom: 20px; }
        button.main-btn { flex: 1; padding: 15px; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; font-weight: bold; color: white; }
        #startBtn { background: var(--primary); }
        #pauseBtn { background: var(--warning); display: none; }
        #stopBtn { background: var(--danger); display: none; }
        #addManualBtn { background: #666; width: 100%; margin-bottom: 20px; }

        .chart-section { margin: 20px 0; padding: 15px; background: #fafafa; border-radius: 10px; border: 1px solid #eee; }
        
        .history-item { background: #fafafa; border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .btn-group { display: flex; gap: 10px; }
        .edit-btn { background: #eee; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .delete-btn { background: #ffebeb; color: var(--danger); border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        
        .hidden { display: none !important; }
        .guest-msg { text-align:center; padding:50px 0; color:#777; }

        /* モーダル */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal-content h3 { margin-top: 0; }
        .modal-content label { font-size: 0.8rem; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <div class="auth-section">
        <button id="authBtn">ログイン / 新規登録</button>
        <div id="userInfo" class="user-info">
            <span id="userEmail" style="font-size: 0.8rem; color: #666;"></span>
            <button id="logoutBtn">ログアウト</button>
        </div>
    </div>

    <h2 style="text-align: center; color: #333;">Time Tracker Pro</h2>

    <div id="guestMsg" class="guest-msg">
        <p>ログインして計測を開始しましょう。</p>
    </div>

    <div id="appContent" class="hidden">
        <div class="input-group">
            <select id="categorySelect">
                <option value="仕事">仕事</option>
                <option value="学習">学習</option>
                <option value="その他">その他</option>
            </select>
            <input type="text" id="memoInput" placeholder="具体的に何をする？">
        </div>
        <div class="timer-display" id="display">00:00:00</div>
        <div class="controls">
            <button id="startBtn" class="main-btn" onclick="startTimer()">計測開始</button>
            <button id="pauseBtn" class="main-btn" onclick="togglePause()">一時停止</button>
            <button id="stopBtn" class="main-btn" onclick="stopTimer()">ストップ</button>
        </div>
        <button id="addManualBtn" class="main-btn" onclick="openManualModal()">+ 手動で記録を追加</button>

        <div class="chart-section">
            <canvas id="pieChart"></canvas>
            <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
            <canvas id="barChart"></canvas>
        </div>

        <ul id="historyList" style="list-style: none; padding: 0;"></ul>
    </div>
</div>

<div id="editModal" class="modal hidden">
    <div class="modal-content">
        <h3 id="modalTitle">記録の編集</h3>
        <label>日付/開始時間</label><br>
        <input type="datetime-local" id="editStart" style="width:100%; margin-bottom:15px;"><br>
        <label>カテゴリ</label><br>
        <select id="editCategory" style="width:100%; margin-bottom:15px;">
            <option value="仕事">仕事</option>
            <option value="学習">学習</option>
            <option value="その他">その他</option>
        </select><br>
        <label>メモ</label><br>
        <input type="text" id="editMemo" style="width:100%; margin-bottom:15px;"><br>
        <label>測定時間 (00:00:00形式)</label><br>
        <input type="text" id="editDuration" style="width:100%; margin-bottom:20px;"><br>
        <div style="display: flex; gap: 10px;">
            <button onclick="saveEdit()" style="background:var(--success); color:white; padding:12px; flex:1; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">保存</button>
            <button onclick="closeModal()" style="background:#ccc; color:white; padding:12px; flex:1; border:none; border-radius:8px; cursor:pointer;">閉じる</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, updateDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        // --- 設定を貼り付け ---
        apiKey: "AIzaSyCX7NamPFOs9ktRy05Pvh1c5wqdwSsXcAI",
        authDomain: "my-time0.firebaseapp.com",
        projectId: "my-time0",
        storageBucket: "my-time0.firebasestorage.app",
        messagingSenderId: "261667531904",
        appId: "1:261667531904:web:3201b06534b7946fe00a65",
        measurementId: "G-TQLNLGVQ52"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let logs = [];
    let currentUser = null;
    let timerInterval, startTime;
    let elapsedTime = 0;
    let isPaused = false;
    let currentEditId = null;
    let myPieChart = null, myBarChart = null;

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('authBtn').style.display = 'none';
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('appContent').classList.remove('hidden');
            document.getElementById('guestMsg').classList.add('hidden');
            document.getElementById('userEmail').textContent = user.email;
            await loadLogs();
        } else {
            currentUser = null;
            document.getElementById('authBtn').style.display = 'block';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('appContent').classList.add('hidden');
            document.getElementById('guestMsg').classList.remove('hidden');
        }
    });

    // --- タイマー ---
    window.startTimer = () => {
        startTime = Date.now() - elapsedTime;
        timerInterval = setInterval(() => {
            const diff = Date.now() - startTime;
            const h = String(Math.floor(diff / 3600000)).padStart(2, '0');
            const m = String(Math.floor((diff % 3600000) / 60000)).padStart(2, '0');
            const s = String(Math.floor((diff % 60000) / 1000)).padStart(2, '0');
            document.getElementById('display').textContent = `${h}:${m}:${s}`;
        }, 1000);
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('pauseBtn').style.display = 'block';
        document.getElementById('stopBtn').style.display = 'block';
        isPaused = false;
    };

    window.togglePause = () => {
        if (!isPaused) {
            clearInterval(timerInterval);
            elapsedTime = Date.now() - startTime;
            document.getElementById('pauseBtn').textContent = '再開';
            document.getElementById('pauseBtn').style.background = 'var(--success)';
            isPaused = true;
        } else {
            startTimer();
            document.getElementById('pauseBtn').textContent = '一時停止';
            document.getElementById('pauseBtn').style.background = 'var(--warning)';
        }
    };

    window.stopTimer = async () => {
        clearInterval(timerInterval);
        const duration = document.getElementById('display').textContent;
        const logData = {
            userId: currentUser.uid,
            category: document.getElementById('categorySelect').value,
            memo: document.getElementById('memoInput').value || '',
            start: new Date(startTime).toISOString(),
            duration: duration,
            createdAt: new Date()
        };
        await addDoc(collection(db, "timeLogs"), logData);
        resetTimerUI();
        await loadLogs();
    };

    function resetTimerUI() {
        clearInterval(timerInterval);
        elapsedTime = 0;
        document.getElementById('display').textContent = '00:00:00';
        document.getElementById('startBtn').style.display = 'block';
        document.getElementById('pauseBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'none';
        document.getElementById('memoInput').value = '';
    }

    // --- 手動・編集 ---
    window.openManualModal = () => {
        currentEditId = null;
        document.getElementById('modalTitle').textContent = "手動で記録を追加";
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('editStart').value = now.toISOString().slice(0,16);
        document.getElementById('editMemo').value = "";
        document.getElementById('editDuration').value = "01:00:00";
        document.getElementById('editModal').classList.remove('hidden');
    };

    window.editLog = (id) => {
        const log = logs.find(l => l.id === id);
        currentEditId = id;
        document.getElementById('modalTitle').textContent = "記録の編集";
        const d = new Date(log.start);
        d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
        document.getElementById('editStart').value = d.toISOString().slice(0,16);
        document.getElementById('editCategory').value = log.category;
        document.getElementById('editMemo').value = log.memo;
        document.getElementById('editDuration').value = log.duration;
        document.getElementById('editModal').classList.remove('hidden');
    };

    window.saveEdit = async () => {
        const logData = {
            category: document.getElementById('editCategory').value,
            memo: document.getElementById('editMemo').value,
            start: new Date(document.getElementById('editStart').value).toISOString(),
            duration: document.getElementById('editDuration').value
        };
        if (currentEditId) {
            await updateDoc(doc(db, "timeLogs", currentEditId), logData);
        } else {
            logData.userId = currentUser.uid;
            logData.createdAt = new Date();
            await addDoc(collection(db, "timeLogs"), logData);
        }
        closeModal();
        await loadLogs();
    };

    window.closeModal = () => document.getElementById('editModal').classList.add('hidden');

    async function loadLogs() {
        if (!currentUser) return;
        const q = query(collection(db, "timeLogs"), where("userId", "==", currentUser.uid), orderBy("start", "desc"));
        const snap = await getDocs(q);
        logs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderHistory();
        updateCharts();
    }

    function renderHistory() {
        const list = document.getElementById('historyList');
        list.innerHTML = '<h3 style="margin-top:30px;">履歴</h3>';
        logs.slice(0, 10).forEach(log => {
            const li = document.createElement('li');
            li.className = 'history-item';
            li.innerHTML = `
                <div>
                    <strong>${log.category}</strong>: ${log.memo || '(なし)'}<br>
                    <small>${new Date(log.start).toLocaleString()} | ${log.duration}</small>
                </div>
                <div class="btn-group">
                    <button class="edit-btn" onclick="editLog('${log.id}')">編集</button>
                    <button class="delete-btn" onclick="deleteLog('${log.id}')">削除</button>
                </div>`;
            list.appendChild(li);
        });
    }

    // --- グラフ ---
    function formatDurationJP(s) {
        const h = Math.floor(s/3600); const m = Math.floor((s%3600)/60);
        return h > 0 ? `${h}時間${m}分` : `${m}分`;
    }

    function updateCharts() {
        if (logs.length === 0) return;
        const memoSummary = {}; const dailyData = {}; const last7Days = [];
        const today = new Date(); today.setHours(0,0,0,0);
        for(let i=6; i>=0; i--) {
            const d = new Date(today); d.setDate(d.getDate()-i);
            const s = `${d.getMonth()+1}/${d.getDate()}`;
            last7Days.push(s); dailyData[s] = 0;
        }
        logs.forEach(l => {
            const [h,m,s] = l.duration.split(':').map(Number);
            const sec = (h*3600)+(m*60)+s;
            const key = l.memo ? `${l.category}: ${l.memo}` : l.category;
            memoSummary[key] = (memoSummary[key]||0)+sec;
            const dStr = `${new Date(l.start).getMonth()+1}/${new Date(l.start).getDate()}`;
            if(dailyData.hasOwnProperty(dStr)) dailyData[dStr] += sec;
        });

        const ctxP = document.getElementById('pieChart').getContext('2d');
        if(myPieChart) myPieChart.destroy();
        myPieChart = new Chart(ctxP, {
            type: 'doughnut',
            data: { labels: Object.keys(memoSummary), datasets: [{ data: Object.values(memoSummary).map(s => (s/3600).toFixed(2)), backgroundColor: ['#4a90e2','#27ae60','#f1c40f','#e67e22','#9b59b6'] }] },
            options: { plugins: { title: { display:true, text:'内訳 (時間)' } } }
        });

        const ctxB = document.getElementById('barChart').getContext('2d');
        if(myBarChart) myBarChart.destroy();
        myBarChart = new Chart(ctxB, {
            type: 'bar',
            data: { labels: last7Days, datasets: [{ label:'稼働時間', data: last7Days.map(d => (dailyData[d]/3600).toFixed(2)), backgroundColor:'#4a90e2' }] },
            options: { scales: { y: { min:0, max:12, ticks: { stepSize:1 } } }, plugins: { title: { display:true, text:'7日間の推移' } } }
        });
    }

    window.deleteLog = async (id) => {
        if(confirm('削除しますか？')) { await deleteDoc(doc(db, "timeLogs", id)); await loadLogs(); }
    };

    document.getElementById('authBtn').onclick = async () => {
        const email = prompt("メールアドレス");
        const password = prompt("パスワード(6文字以上)");
        if(email && password) {
            try { await signInWithEmailAndPassword(auth, email, password); }
            catch { try { await createUserWithEmailAndPassword(auth, email, password); } catch(e) { alert(e.message); } }
        }
    };
    document.getElementById('logoutBtn').onclick = () => signOut(auth);
</script>
</body>
</html>
